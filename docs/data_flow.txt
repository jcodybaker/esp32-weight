```
BTHome Sensor Integration - Data Flow
======================================

BLE Advertisement         BTHome Observer          Sensor System           Web Display
─────────────────        ─────────────────        ─────────────           ───────────

┌──────────────┐
│ BTHome       │
│ Device       │
│ (Temp=23.5°C)│
└──────┬───────┘
       │
       │ BLE Advertisement
       │
       ▼
┌─────────────────────────────────────────────────────────────────┐
│ bthome_packet_callback()                                        │
│                                                                 │
│ 1. Cache packet (existing)                                     │
│    └─► packet_cache[MAC] = {packet, rssi, timestamp}          │
│                                                                 │
│ 2. Extract device name (if available)                          │
│    └─► "Living Room" or fallback to MAC suffix                │
│                                                                 │
│ 3. For each measurement in packet:                             │
│    ┌────────────────────────────────────────────────────┐     │
│    │ find_or_register_bthome_sensor()                   │     │
│    │                                                     │     │
│    │ Check sensor map:                                  │     │
│    │ ┌────────────────────────────────────┐            │     │
│    │ │ Is (MAC + object_id) registered?   │            │     │
│    │ └─────────┬──────────────────────────┘            │     │
│    │           │                                         │     │
│    │      ┌────┴────┐                                   │     │
│    │      │   YES   │   NO                              │     │
│    │      │         │                                   │     │
│    │      ▼         ▼                                   │     │
│    │  Return    Register New Sensor                     │     │
│    │  sensor_id ────────────────────────►               │     │
│    │              sensors_register()                    │────────────┐
│    │              ("Living Room Temp", "°C")           │     │      │
│    │                                                     │     │      │
│    │              Store mapping:                         │     │      │
│    │              MAC + object_id → sensor_id           │     │      │
│    └────────────────────────────────────────────────────┘     │      │
│                                                                 │      │
│ 4. Update sensor value:                                        │      │
│    └─► sensors_update(sensor_id, 23.5, true) ─────────────────┼──────┤
│                                                                 │      │
└─────────────────────────────────────────────────────────────────┘      │
                                                                          │
                                                                          ▼
                                                        ┌──────────────────────────────┐
                                                        │ Sensor Registry              │
                                                        │                              │
                                                        │ sensors[0] = {               │
                                                        │   name: "Weight"             │
                                                        │   unit: "g"                  │
                                                        │   value: 1234.56             │
                                                        │   timestamp: 1733456789      │
                                                        │   available: true            │
                                                        │ }                            │
                                                        │                              │
                                                        │ sensors[1] = {               │
                                                        │   name: "Weight"             │
                                                        │   unit: "lbs"                │
                                                        │   value: 2.72                │
                                                        │   timestamp: 1733456789      │
                                                        │   available: true            │
                                                        │ }                            │
                                                        │                              │
                                                        │ sensors[2] = {               │
                                                        │   name: "Living Room Temp"   │
                                                        │   unit: "°C"                 │
                                                        │   value: 23.5                │
                                                        │   timestamp: 1733456790      │
                                                        │   available: true            │
                                                        │ }                            │
                                                        │                              │
                                                        │ sensors[3] = {               │
                                                        │   name: "Living Room Humidity"│
                                                        │   unit: "%"                  │
                                                        │   value: 65.2                │
                                                        │   timestamp: 1733456790      │
                                                        │   available: true            │
                                                        │ }                            │
                                                        └────────────┬─────────────────┘
                                                                     │
                                                                     │
                                      ┌──────────────────────────────┘
                                      │
                                      │ HTTP Request: GET /sensors/data
                                      │
                                      ▼
                            ┌────────────────────────┐
                            │ sensors_data_handler() │
                            │                        │
                            │ Build JSON:            │
                            │ {                      │
                            │   "sensors": [         │
                            │     { ... },           │
                            │     { ... }            │
                            │   ]                    │
                            │ }                      │
                            └────────┬───────────────┘
                                     │
                                     │ JSON Response
                                     │
                                     ▼
                            ┌──────────────────────────────────┐
                            │ Web Browser                      │
                            │                                  │
                            │ JavaScript fetches /sensors/data │
                            │ every 1 second                   │
                            │                                  │
                            │ Updates display:                 │
                            │                                  │
                            │ ┌─────────────────┐             │
                            │ │ Weight          │             │
                            │ │    1,234.56     │             │
                            │ │       g         │             │
                            │ └─────────────────┘             │
                            │                                  │
                            │ ┌─────────────────┐             │
                            │ │ Living Room Temp│             │
                            │ │     23.5        │             │
                            │ │      °C         │             │
                            │ └─────────────────┘             │
                            │                                  │
                            │ ┌─────────────────┐             │
                            │ │ Living Room Hum │             │
                            │ │     65.2        │             │
                            │ │       %         │             │
                            │ └─────────────────┘             │
                            └──────────────────────────────────┘


Key Data Structures
===================

bthome_sensor_mapping_t:
┌──────────────────────┐
│ addr: AA:BB:CC:DD:EE:FF  │ ──┐
│ object_id: 0x02      │   │ Unique Key
│ sensor_id: 2         │ ──┘ (lookup)
│ registered: true     │
└──────────────────────┘
         │
         └──► Maps to sensor_data_t in sensors[]

sensor_data_t:
┌──────────────────────────┐
│ name: "Living Room Temp" │
│ unit: "°C"               │
│ value: 23.5              │
│ last_updated: 1733456790 │
│ available: true          │
└──────────────────────────┘
```
